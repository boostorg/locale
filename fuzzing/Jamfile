# Copyright (c) 2024 Matt Borland
# Copyright (c) 2025 Alexander Grund
#
# Distributed under the Boost Software License, Version 1.0.
# https://www.boost.org/LICENSE_1_0.txt.


import common ;
import regex ;

local all_fuzzers = [ regex.replace-list
    [ glob "fuzz_*.cpp" ] : ".cpp" : ""
] ;

for local fuzzer in $(all_fuzzers)
{
    local fuzz_time = 60 ;

    # Create the output corpus directories
    make /tmp/corpus/$(fuzzer) : : common.MkDir ;
    make /tmp/mincorpus/$(fuzzer) : : common.MkDir ;

    # Build the fuzzer
    exe $(fuzzer)
        :
            $(fuzzer).cpp
        : requirements
            <debug-symbols>on
            <optimization>speed
            <address-sanitizer>on
            <undefined-sanitizer>norecover
            <cxxflags>-fsanitize=fuzzer
            <linkflags>-fsanitize=fuzzer
            <library>/boost/locale//boost_locale
    ;

    # Run the fuzzer for a short while
    run $(fuzzer)
        : <testing.arg>"seedcorpus/$(fuzzer) -max_total_time=$(fuzz_time)"
        : target-name $(fuzzer)-fuzzing
        : requirements
            <dependency>/tmp/corpus/$(fuzzer)
    ;

    # Minimize the corpus
    run $(fuzzer)
        : <testing.arg>"/tmp/mincorpus/$(fuzzer) /tmp/corpus/$(fuzzer) -merge=1"
        : target-name $(fuzzer)-minimize-corpus
        : requirements
            <dependency>$(fuzzer)-fuzzing
            <dependency>/tmp/corpus/$(fuzzer)
            <dependency>/tmp/mincorpus/$(fuzzer)
    ;
}